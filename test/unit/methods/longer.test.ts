import { assertEquals } from "@std/assert";
import SimpleDB from "../../../src/class/SimpleDB.ts";

Deno.test("should tidy data by stacking mutiple columns", async () => {
  const sdb = new SimpleDB();
  const table = sdb.newTable();
  await table.loadData("test/data/files/dataUntidy.json");
  await table.longer(
    ["2015", "2016", "2017", "2018", "2019", "2020"],
    "year",
    "employees",
  );

  const data = await table.getData();
  assertEquals(data, [
    { Department: "accounting", year: "2015", employees: 10 },
    { Department: "accounting", year: "2016", employees: 9 },
    { Department: "accounting", year: "2017", employees: 15 },
    { Department: "accounting", year: "2018", employees: 11 },
    { Department: "accounting", year: "2019", employees: 25 },
    { Department: "accounting", year: "2020", employees: 32 },
    { Department: "R&D", year: "2015", employees: 1 },
    { Department: "R&D", year: "2016", employees: 2 },
    { Department: "R&D", year: "2017", employees: 5 },
    { Department: "R&D", year: "2018", employees: 2 },
    { Department: "R&D", year: "2019", employees: 2 },
    { Department: "R&D", year: "2020", employees: 3 },
    { Department: "sales", year: "2015", employees: 2 },
    { Department: "sales", year: "2016", employees: 7 },
    { Department: "sales", year: "2017", employees: 15 },
    { Department: "sales", year: "2018", employees: 32 },
    { Department: "sales", year: "2019", employees: 45 },
    { Department: "sales", year: "2020", employees: 27 },
  ]);
});
Deno.test("should tidy data by stacking mutiple columns with spaces in their names", async () => {
  const sdb = new SimpleDB();
  const table = sdb.newTable();
  await table.loadArray([
    {
      "Department or unit": "accounting and others",
      "2015": 10,
      "2016": 9,
      "2017": 15,
      "2018": 11,
      "2019": 25,
      "2020": 32,
    },
    {
      "Department or unit": "R & D",
      "2015": 1,
      "2016": 2,
      "2017": 5,
      "2018": 2,
      "2019": 2,
      "2020": 3,
    },
    {
      "Department or unit": "sales and marketing",
      "2015": 2,
      "2016": 7,
      "2017": 15,
      "2018": 32,
      "2019": 45,
      "2020": 27,
    },
  ]);
  await table.longer(
    ["2015", "2016", "2017", "2018", "2019", "2020"],
    "multiples years",
    "employees full-time",
  );

  const data = await table.getData();

  assertEquals(data, [
    {
      "Department or unit": "accounting and others",
      "multiples years": "2015",
      "employees full-time": 10,
    },
    {
      "Department or unit": "accounting and others",
      "multiples years": "2016",
      "employees full-time": 9,
    },
    {
      "Department or unit": "accounting and others",
      "multiples years": "2017",
      "employees full-time": 15,
    },
    {
      "Department or unit": "accounting and others",
      "multiples years": "2018",
      "employees full-time": 11,
    },
    {
      "Department or unit": "accounting and others",
      "multiples years": "2019",
      "employees full-time": 25,
    },
    {
      "Department or unit": "accounting and others",
      "multiples years": "2020",
      "employees full-time": 32,
    },
    {
      "Department or unit": "R & D",
      "multiples years": "2015",
      "employees full-time": 1,
    },
    {
      "Department or unit": "R & D",
      "multiples years": "2016",
      "employees full-time": 2,
    },
    {
      "Department or unit": "R & D",
      "multiples years": "2017",
      "employees full-time": 5,
    },
    {
      "Department or unit": "R & D",
      "multiples years": "2018",
      "employees full-time": 2,
    },
    {
      "Department or unit": "R & D",
      "multiples years": "2019",
      "employees full-time": 2,
    },
    {
      "Department or unit": "R & D",
      "multiples years": "2020",
      "employees full-time": 3,
    },
    {
      "Department or unit": "sales and marketing",
      "multiples years": "2015",
      "employees full-time": 2,
    },
    {
      "Department or unit": "sales and marketing",
      "multiples years": "2016",
      "employees full-time": 7,
    },
    {
      "Department or unit": "sales and marketing",
      "multiples years": "2017",
      "employees full-time": 15,
    },
    {
      "Department or unit": "sales and marketing",
      "multiples years": "2018",
      "employees full-time": 32,
    },
    {
      "Department or unit": "sales and marketing",
      "multiples years": "2019",
      "employees full-time": 45,
    },
    {
      "Department or unit": "sales and marketing",
      "multiples years": "2020",
      "employees full-time": 27,
    },
  ]);
  await sdb.done();
});
Deno.test("should tidy data by stacking mutiple columns and by including null values", async () => {
  const sdb = new SimpleDB();
  const table = sdb.newTable();
  await table.loadData("test/data/files/dataUntidyWithNulls.json");
  await table.longer(
    ["2015", "2016", "2017", "2018", "2019", "2020"],
    "year",
    "employees",
  );

  const data = await table.getData();

  assertEquals(data, [
    { Department: "accounting", year: "2015", employees: null },
    { Department: "accounting", year: "2016", employees: 9 },
    { Department: "accounting", year: "2017", employees: 15 },
    { Department: "accounting", year: "2018", employees: 11 },
    { Department: "accounting", year: "2019", employees: 25 },
    { Department: "accounting", year: "2020", employees: 32 },
    { Department: "R&D", year: "2015", employees: 1 },
    { Department: "R&D", year: "2016", employees: 2 },
    { Department: "R&D", year: "2017", employees: null },
    { Department: "R&D", year: "2018", employees: 2 },
    { Department: "R&D", year: "2019", employees: 2 },
    { Department: "R&D", year: "2020", employees: 3 },
    { Department: "sales", year: "2015", employees: 2 },
    { Department: "sales", year: "2016", employees: 7 },
    { Department: "sales", year: "2017", employees: 15 },
    { Department: "sales", year: "2018", employees: 32 },
    { Department: "sales", year: "2019", employees: 45 },
    { Department: "sales", year: "2020", employees: null },
  ]);
  await sdb.done();
});

Deno.test("should tidy data with columns with $ in their names", async () => {
  const sdb = new SimpleDB();
  const table = sdb.newTable();
  await table.loadArray([
    {
      v0: "1998",
      "Breaking and entering": "1,163",
      "Motor vehicle theft": "550",
      Robbery: "109",
      "Shoplifting of $5,000 or under": "303",
      "Theft of $5,000 or under": "2,063",
    },
    {
      v0: "1999",
      "Breaking and entering": "1,046",
      "Motor vehicle theft": "531",
      Robbery: "107",
      "Shoplifting of $5,000 or under": "276",
      "Theft of $5,000 or under": "1,955",
    },
    {
      v0: "2000",
      "Breaking and entering": "956",
      "Motor vehicle theft": "522",
      Robbery: "100",
      "Shoplifting of $5,000 or under": "262",
      "Theft of $5,000 or under": "1,899",
    },
    {
      v0: "2001",
      "Breaking and entering": "901",
      "Motor vehicle theft": "544",
      Robbery: "99",
      "Shoplifting of $5,000 or under": "258",
      "Theft of $5,000 or under": "1,869",
    },
    {
      v0: "2002",
      "Breaking and entering": "879",
      "Motor vehicle theft": "516",
      Robbery: "96",
      "Shoplifting of $5,000 or under": "257",
      "Theft of $5,000 or under": "1,871",
    },
    {
      v0: "2003",
      "Breaking and entering": "901",
      "Motor vehicle theft": "551",
      Robbery: "101",
      "Shoplifting of $5,000 or under": "271",
      "Theft of $5,000 or under": "1,944",
    },
    {
      v0: "2004",
      "Breaking and entering": "864",
      "Motor vehicle theft": "532",
      Robbery: "97",
      "Shoplifting of $5,000 or under": "240",
      "Theft of $5,000 or under": "1,871",
    },
    {
      v0: "2005",
      "Breaking and entering": "811",
      "Motor vehicle theft": "496",
      Robbery: "101",
      "Shoplifting of $5,000 or under": "237",
      "Theft of $5,000 or under": "1,743",
    },
    {
      v0: "2006",
      "Breaking and entering": "772",
      "Motor vehicle theft": "487",
      Robbery: "106",
      "Shoplifting of $5,000 or under": "245",
      "Theft of $5,000 or under": "1,652",
    },
    {
      v0: "2007",
      "Breaking and entering": "704",
      "Motor vehicle theft": "443",
      Robbery: "104",
      "Shoplifting of $5,000 or under": "234",
      "Theft of $5,000 or under": "1,530",
    },
    {
      v0: "2008",
      "Breaking and entering": "635",
      "Motor vehicle theft": "378",
      Robbery: "97",
      "Shoplifting of $5,000 or under": "238",
      "Theft of $5,000 or under": "1,425",
    },
    {
      v0: "2009",
      "Breaking and entering": "613",
      "Motor vehicle theft": "321",
      Robbery: "97",
      "Shoplifting of $5,000 or under": "276",
      "Theft of $5,000 or under": "1,386",
    },
    {
      v0: "2010",
      "Breaking and entering": "579",
      "Motor vehicle theft": "272",
      Robbery: "90",
      "Shoplifting of $5,000 or under": "268",
      "Theft of $5,000 or under": "1,286",
    },
    {
      v0: "2011",
      "Breaking and entering": "528",
      "Motor vehicle theft": "240",
      Robbery: "87",
      "Shoplifting of $5,000 or under": "260",
      "Theft of $5,000 or under": "1,197",
    },
    {
      v0: "2012",
      "Breaking and entering": "508",
      "Motor vehicle theft": "225",
      Robbery: "80",
      "Shoplifting of $5,000 or under": "264",
      "Theft of $5,000 or under": "1,175",
    },
    {
      v0: "2013",
      "Breaking and entering": "446",
      "Motor vehicle theft": "207",
      Robbery: "66",
      "Shoplifting of $5,000 or under": "250",
      "Theft of $5,000 or under": "1,096",
    },
    {
      v0: "2014",
      "Breaking and entering": "429",
      "Motor vehicle theft": "209",
      Robbery: "59",
      "Shoplifting of $5,000 or under": "265",
      "Theft of $5,000 or under": "1,069",
    },
    {
      v0: "2015",
      "Breaking and entering": "447",
      "Motor vehicle theft": "221",
      Robbery: "62",
      "Shoplifting of $5,000 or under": "280",
      "Theft of $5,000 or under": "1,085",
    },
    {
      v0: "2016",
      "Breaking and entering": "444",
      "Motor vehicle theft": "219",
      Robbery: "61",
      "Shoplifting of $5,000 or under": "285",
      "Theft of $5,000 or under": "1,091",
    },
    {
      v0: "2017",
      "Breaking and entering": "437",
      "Motor vehicle theft": "233",
      Robbery: "62",
      "Shoplifting of $5,000 or under": "296",
      "Theft of $5,000 or under": "1,086",
    },
    {
      v0: "2018",
      "Breaking and entering": "432",
      "Motor vehicle theft": "232",
      Robbery: "61",
      "Shoplifting of $5,000 or under": "337",
      "Theft of $5,000 or under": "1,099",
    },
    {
      v0: "2019",
      "Breaking and entering": "429",
      "Motor vehicle theft": "231",
      Robbery: "62",
      "Shoplifting of $5,000 or under": "373",
      "Theft of $5,000 or under": "1,129",
    },
    {
      v0: "2020",
      "Breaking and entering": "363",
      "Motor vehicle theft": "206",
      Robbery: "51",
      "Shoplifting of $5,000 or under": "240",
      "Theft of $5,000 or under": "910",
    },
    {
      v0: "2021",
      "Breaking and entering": "329",
      "Motor vehicle theft": "218",
      Robbery: "49",
      "Shoplifting of $5,000 or under": "249",
      "Theft of $5,000 or under": "879",
    },
    {
      v0: "2022",
      "Breaking and entering": "342",
      "Motor vehicle theft": "272",
      Robbery: "56",
      "Shoplifting of $5,000 or under": "329",
      "Theft of $5,000 or under": "964",
    },
    {
      v0: "2023",
      "Breaking and entering": "326",
      "Motor vehicle theft": "286",
      Robbery: "59",
      "Shoplifting of $5,000 or under": "387",
      "Theft of $5,000 or under": "924",
    },
  ]);

  await table.longer(
    [
      "Breaking and entering",
      "Motor vehicle theft",
      "Robbery",
      "Shoplifting of $5,000 or under",
      "Theft of $5,000 or under",
    ],
    "crime",
    "rate",
  );

  const data = await table.getData();

  assertEquals(data, [
    { "v0": "1998", "crime": "Breaking and entering", "rate": "1,163" },
    { "v0": "1998", "crime": "Motor vehicle theft", "rate": "550" },
    { "v0": "1998", "crime": "Robbery", "rate": "109" },
    { "v0": "1998", "crime": "Shoplifting of $5,000 or under", "rate": "303" },
    { "v0": "1998", "crime": "Theft of $5,000 or under", "rate": "2,063" },
    { "v0": "1999", "crime": "Breaking and entering", "rate": "1,046" },
    { "v0": "1999", "crime": "Motor vehicle theft", "rate": "531" },
    { "v0": "1999", "crime": "Robbery", "rate": "107" },
    { "v0": "1999", "crime": "Shoplifting of $5,000 or under", "rate": "276" },
    { "v0": "1999", "crime": "Theft of $5,000 or under", "rate": "1,955" },
    { "v0": "2000", "crime": "Breaking and entering", "rate": "956" },
    { "v0": "2000", "crime": "Motor vehicle theft", "rate": "522" },
    { "v0": "2000", "crime": "Robbery", "rate": "100" },
    { "v0": "2000", "crime": "Shoplifting of $5,000 or under", "rate": "262" },
    { "v0": "2000", "crime": "Theft of $5,000 or under", "rate": "1,899" },
    { "v0": "2001", "crime": "Breaking and entering", "rate": "901" },
    { "v0": "2001", "crime": "Motor vehicle theft", "rate": "544" },
    { "v0": "2001", "crime": "Robbery", "rate": "99" },
    { "v0": "2001", "crime": "Shoplifting of $5,000 or under", "rate": "258" },
    { "v0": "2001", "crime": "Theft of $5,000 or under", "rate": "1,869" },
    { "v0": "2002", "crime": "Breaking and entering", "rate": "879" },
    { "v0": "2002", "crime": "Motor vehicle theft", "rate": "516" },
    { "v0": "2002", "crime": "Robbery", "rate": "96" },
    { "v0": "2002", "crime": "Shoplifting of $5,000 or under", "rate": "257" },
    { "v0": "2002", "crime": "Theft of $5,000 or under", "rate": "1,871" },
    { "v0": "2003", "crime": "Breaking and entering", "rate": "901" },
    { "v0": "2003", "crime": "Motor vehicle theft", "rate": "551" },
    { "v0": "2003", "crime": "Robbery", "rate": "101" },
    { "v0": "2003", "crime": "Shoplifting of $5,000 or under", "rate": "271" },
    { "v0": "2003", "crime": "Theft of $5,000 or under", "rate": "1,944" },
    { "v0": "2004", "crime": "Breaking and entering", "rate": "864" },
    { "v0": "2004", "crime": "Motor vehicle theft", "rate": "532" },
    { "v0": "2004", "crime": "Robbery", "rate": "97" },
    { "v0": "2004", "crime": "Shoplifting of $5,000 or under", "rate": "240" },
    { "v0": "2004", "crime": "Theft of $5,000 or under", "rate": "1,871" },
    { "v0": "2005", "crime": "Breaking and entering", "rate": "811" },
    { "v0": "2005", "crime": "Motor vehicle theft", "rate": "496" },
    { "v0": "2005", "crime": "Robbery", "rate": "101" },
    { "v0": "2005", "crime": "Shoplifting of $5,000 or under", "rate": "237" },
    { "v0": "2005", "crime": "Theft of $5,000 or under", "rate": "1,743" },
    { "v0": "2006", "crime": "Breaking and entering", "rate": "772" },
    { "v0": "2006", "crime": "Motor vehicle theft", "rate": "487" },
    { "v0": "2006", "crime": "Robbery", "rate": "106" },
    { "v0": "2006", "crime": "Shoplifting of $5,000 or under", "rate": "245" },
    { "v0": "2006", "crime": "Theft of $5,000 or under", "rate": "1,652" },
    { "v0": "2007", "crime": "Breaking and entering", "rate": "704" },
    { "v0": "2007", "crime": "Motor vehicle theft", "rate": "443" },
    { "v0": "2007", "crime": "Robbery", "rate": "104" },
    { "v0": "2007", "crime": "Shoplifting of $5,000 or under", "rate": "234" },
    { "v0": "2007", "crime": "Theft of $5,000 or under", "rate": "1,530" },
    { "v0": "2008", "crime": "Breaking and entering", "rate": "635" },
    { "v0": "2008", "crime": "Motor vehicle theft", "rate": "378" },
    { "v0": "2008", "crime": "Robbery", "rate": "97" },
    { "v0": "2008", "crime": "Shoplifting of $5,000 or under", "rate": "238" },
    { "v0": "2008", "crime": "Theft of $5,000 or under", "rate": "1,425" },
    { "v0": "2009", "crime": "Breaking and entering", "rate": "613" },
    { "v0": "2009", "crime": "Motor vehicle theft", "rate": "321" },
    { "v0": "2009", "crime": "Robbery", "rate": "97" },
    { "v0": "2009", "crime": "Shoplifting of $5,000 or under", "rate": "276" },
    { "v0": "2009", "crime": "Theft of $5,000 or under", "rate": "1,386" },
    { "v0": "2010", "crime": "Breaking and entering", "rate": "579" },
    { "v0": "2010", "crime": "Motor vehicle theft", "rate": "272" },
    { "v0": "2010", "crime": "Robbery", "rate": "90" },
    { "v0": "2010", "crime": "Shoplifting of $5,000 or under", "rate": "268" },
    { "v0": "2010", "crime": "Theft of $5,000 or under", "rate": "1,286" },
    { "v0": "2011", "crime": "Breaking and entering", "rate": "528" },
    { "v0": "2011", "crime": "Motor vehicle theft", "rate": "240" },
    { "v0": "2011", "crime": "Robbery", "rate": "87" },
    { "v0": "2011", "crime": "Shoplifting of $5,000 or under", "rate": "260" },
    { "v0": "2011", "crime": "Theft of $5,000 or under", "rate": "1,197" },
    { "v0": "2012", "crime": "Breaking and entering", "rate": "508" },
    { "v0": "2012", "crime": "Motor vehicle theft", "rate": "225" },
    { "v0": "2012", "crime": "Robbery", "rate": "80" },
    { "v0": "2012", "crime": "Shoplifting of $5,000 or under", "rate": "264" },
    { "v0": "2012", "crime": "Theft of $5,000 or under", "rate": "1,175" },
    { "v0": "2013", "crime": "Breaking and entering", "rate": "446" },
    { "v0": "2013", "crime": "Motor vehicle theft", "rate": "207" },
    { "v0": "2013", "crime": "Robbery", "rate": "66" },
    { "v0": "2013", "crime": "Shoplifting of $5,000 or under", "rate": "250" },
    { "v0": "2013", "crime": "Theft of $5,000 or under", "rate": "1,096" },
    { "v0": "2014", "crime": "Breaking and entering", "rate": "429" },
    { "v0": "2014", "crime": "Motor vehicle theft", "rate": "209" },
    { "v0": "2014", "crime": "Robbery", "rate": "59" },
    { "v0": "2014", "crime": "Shoplifting of $5,000 or under", "rate": "265" },
    { "v0": "2014", "crime": "Theft of $5,000 or under", "rate": "1,069" },
    { "v0": "2015", "crime": "Breaking and entering", "rate": "447" },
    { "v0": "2015", "crime": "Motor vehicle theft", "rate": "221" },
    { "v0": "2015", "crime": "Robbery", "rate": "62" },
    { "v0": "2015", "crime": "Shoplifting of $5,000 or under", "rate": "280" },
    { "v0": "2015", "crime": "Theft of $5,000 or under", "rate": "1,085" },
    { "v0": "2016", "crime": "Breaking and entering", "rate": "444" },
    { "v0": "2016", "crime": "Motor vehicle theft", "rate": "219" },
    { "v0": "2016", "crime": "Robbery", "rate": "61" },
    { "v0": "2016", "crime": "Shoplifting of $5,000 or under", "rate": "285" },
    { "v0": "2016", "crime": "Theft of $5,000 or under", "rate": "1,091" },
    { "v0": "2017", "crime": "Breaking and entering", "rate": "437" },
    { "v0": "2017", "crime": "Motor vehicle theft", "rate": "233" },
    { "v0": "2017", "crime": "Robbery", "rate": "62" },
    { "v0": "2017", "crime": "Shoplifting of $5,000 or under", "rate": "296" },
    { "v0": "2017", "crime": "Theft of $5,000 or under", "rate": "1,086" },
    { "v0": "2018", "crime": "Breaking and entering", "rate": "432" },
    { "v0": "2018", "crime": "Motor vehicle theft", "rate": "232" },
    { "v0": "2018", "crime": "Robbery", "rate": "61" },
    { "v0": "2018", "crime": "Shoplifting of $5,000 or under", "rate": "337" },
    { "v0": "2018", "crime": "Theft of $5,000 or under", "rate": "1,099" },
    { "v0": "2019", "crime": "Breaking and entering", "rate": "429" },
    { "v0": "2019", "crime": "Motor vehicle theft", "rate": "231" },
    { "v0": "2019", "crime": "Robbery", "rate": "62" },
    { "v0": "2019", "crime": "Shoplifting of $5,000 or under", "rate": "373" },
    { "v0": "2019", "crime": "Theft of $5,000 or under", "rate": "1,129" },
    { "v0": "2020", "crime": "Breaking and entering", "rate": "363" },
    { "v0": "2020", "crime": "Motor vehicle theft", "rate": "206" },
    { "v0": "2020", "crime": "Robbery", "rate": "51" },
    { "v0": "2020", "crime": "Shoplifting of $5,000 or under", "rate": "240" },
    { "v0": "2020", "crime": "Theft of $5,000 or under", "rate": "910" },
    { "v0": "2021", "crime": "Breaking and entering", "rate": "329" },
    { "v0": "2021", "crime": "Motor vehicle theft", "rate": "218" },
    { "v0": "2021", "crime": "Robbery", "rate": "49" },
    { "v0": "2021", "crime": "Shoplifting of $5,000 or under", "rate": "249" },
    { "v0": "2021", "crime": "Theft of $5,000 or under", "rate": "879" },
    { "v0": "2022", "crime": "Breaking and entering", "rate": "342" },
    { "v0": "2022", "crime": "Motor vehicle theft", "rate": "272" },
    { "v0": "2022", "crime": "Robbery", "rate": "56" },
    { "v0": "2022", "crime": "Shoplifting of $5,000 or under", "rate": "329" },
    { "v0": "2022", "crime": "Theft of $5,000 or under", "rate": "964" },
    { "v0": "2023", "crime": "Breaking and entering", "rate": "326" },
    { "v0": "2023", "crime": "Motor vehicle theft", "rate": "286" },
    { "v0": "2023", "crime": "Robbery", "rate": "59" },
    { "v0": "2023", "crime": "Shoplifting of $5,000 or under", "rate": "387" },
    { "v0": "2023", "crime": "Theft of $5,000 or under", "rate": "924" },
  ]);
});
