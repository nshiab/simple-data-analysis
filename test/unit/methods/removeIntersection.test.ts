import { assertEquals } from "jsr:@std/assert";
import SimpleDB from "../../../src/class/SimpleDB.ts";

const sdb = new SimpleDB();

Deno.test("should remove the small circle from the big circle", async () => {
  const smallCircle = sdb.newTable();
  await smallCircle.loadGeoData("test/geodata/files/smallCircle.json");
  await smallCircle.renameColumns({ geom: "geomSmall" });

  const bigCircle = sdb.newTable();
  await bigCircle.loadGeoData("test/geodata/files/bigCircle.json");
  await bigCircle.renameColumns({ geom: "geomBig" });

  await smallCircle.crossJoin(bigCircle);

  await smallCircle.removeIntersection(
    "geomBig",
    "geomSmall",
    "bigCircleWithHole",
  );

  await smallCircle.selectColumns("bigCircleWithHole");

  const data = await smallCircle.getGeoData();
  assertEquals(data, {
    type: "FeatureCollection",
    features: [
      {
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [-102.20845245489919, 63.77651962314209],
              [-104.75416338454315, 63.541740399843654],
              [-107.17912759209037, 63.15714716302817],
              [-109.43394115560132, 62.63219692105078],
              [-111.48020910935922, 61.97905276196434],
              [-113.2913391869973, 61.211755601371244],
              [-114.85195102674545, 60.34542259828908],
              [-116.15634998030201, 59.39555726974163],
              [-117.2065505566899, 58.37751319941964],
              [-118.01024432012558, 57.30611668506949],
              [-118.57896778847636, 56.19543003666883],
              [-118.92659490304725, 55.05862633286381],
              [-119.06818288403291, 53.90794479148845],
              [-119.01914338244916, 52.754699491350195],
              [-118.79468478776344, 51.609319847270186],
              [-118.40946552063005, 50.48140704659403],
              [-117.87740291984369, 49.37979565981956],
              [-117.21159161920362, 48.31261354266437],
              [-116.42429543359316, 47.287335995261415],
              [-115.5269859323445, 46.310832119459036],
              [-114.53040840615304, 45.38940262875682],
              [-113.44466176895766, 44.5288092054708],
              [-112.27928328592543, 43.73429601458512],
              [-111.04333217565424, 43.01060428163732],
              [-109.74546838582663, 42.36198099755113],
              [-108.39402443082822, 41.79218287564473],
              [-106.9970692990411, 41.304476685911766],
              [-105.56246422944757, 40.901637047570645],
              [-104.09791072371894, 40.58594268345779],
              [-102.61099157091324, 40.35917203521199],
              [-101.10920596307574, 40.22259901022967],
              [-99.6000000000003, 40.17698948322103],
              [-98.09079403692488, 40.22259901022967],
              [-96.58900842908737, 40.35917203521199],
              [-95.10208927628166, 40.58594268345779],
              [-93.63753577055306, 40.90163704757064],
              [-92.20293070095951, 41.304476685911766],
              [-90.80597556917238, 41.79218287564473],
              [-89.45453161417399, 42.36198099755113],
              [-88.15666782434636, 43.01060428163732],
              [-86.92071671407517, 43.73429601458512],
              [-85.75533823104296, 44.52880920547079],
              [-84.66959159384757, 45.38940262875682],
              [-83.67301406765614, 46.310832119459036],
              [-82.77570456640746, 47.287335995261415],
              [-81.988408380797, 48.31261354266437],
              [-81.32259708015691, 49.37979565981956],
              [-80.79053447937056, 50.48140704659403],
              [-80.40531521223718, 51.60931984727017],
              [-80.18085661755147, 52.754699491350195],
              [-80.1318171159677, 53.90794479148845],
              [-80.27340509695335, 55.05862633286381],
              [-80.62103221152425, 56.19543003666883],
              [-81.189755679875, 57.30611668506949],
              [-81.99344944331074, 58.37751319941964],
              [-83.04365001969857, 59.39555726974163],
              [-84.34804897325515, 60.34542259828908],
              [-85.9086608130033, 61.211755601371244],
              [-87.71979089064139, 61.97905276196434],
              [-89.76605884439931, 62.63219692105078],
              [-92.02087240791022, 63.15714716302817],
              [-94.44583661545745, 63.541740399843654],
              [-96.99154754510141, 63.77651962314209],
              [-99.6000000000003, 63.85546819937955],
              [-102.20845245489919, 63.77651962314209],
            ],
            [
              [-96.4144363575346, 56.655932181702994],
              [-95.81571313845996, 56.60271503740913],
              [-95.23177713901174, 56.514753897581066],
              [-94.66963769625845, 56.393133163442606],
              [-94.13586285934014, 56.23933836340823],
              [-93.63646349387176, 56.0552254559182],
              [-93.17680067034998, 55.842983921788495],
              [-92.76151838810185, 55.60509523908456],
              [-92.39450191469905, 55.344288382771616],
              [-92.07886045253308, 55.06349392592592],
              [-91.81693160657552, 54.76579816155496],
              [-91.61030428473404, 54.45439844264923],
              [-91.45985621981154, 54.13256068279621],
              [-91.3658022181874, 53.803579697611006],
              [-91.32774944336995, 53.47074282007358],
              [-91.34475644809933, 53.1372970057446],
              [-91.41539319355186, 52.806419465352015],
              [-91.53779986620073, 52.48119172534117],
              [-91.70974286583444, 52.164576920266995],
              [-91.92866685325667, 51.85940006008535],
              [-92.1917421903589, 51.568330984572626],
              [-92.4959074687323, 51.29386970981572],
              [-92.8379071056285, 51.038333881702336],
              [-93.21432419420059, 50.80384807300125],
              [-93.62160893855489, 50.592334689251715],
              [-94.05610309479813, 50.40550628055872],
              [-94.51406088865541, 50.24485908873871],
              [-94.9916668992223, 50.11166769014689],
              [-95.48505139653504, 50.00698062273516],
              [-95.99030360591534, 49.93161691081611],
              [-96.50348335096051, 49.88616342249522],
              [-97.02063150467652, 49.87097301298391],
              [-97.53777965839252, 49.88616342249522],
              [-98.05095940343767, 49.93161691081611],
              [-98.55621161281798, 50.00698062273516],
              [-99.04959611013074, 50.11166769014689],
              [-99.52720212069762, 50.24485908873871],
              [-99.9851599145549, 50.40550628055872],
              [-100.41965407079813, 50.592334689251715],
              [-100.82693881515242, 50.80384807300125],
              [-101.20335590372451, 51.038333881702336],
              [-101.54535554062072, 51.29386970981572],
              [-101.84952081899412, 51.568330984572626],
              [-102.11259615609634, 51.85940006008535],
              [-102.33152014351857, 52.164576920266995],
              [-102.50346314315229, 52.48119172534117],
              [-102.62586981580115, 52.806419465352015],
              [-102.6965065612537, 53.1372970057446],
              [-102.71351356598306, 53.47074282007358],
              [-102.6754607911656, 53.803579697611006],
              [-102.58140678954148, 54.13256068279621],
              [-102.43095872461899, 54.45439844264923],
              [-102.22433140277748, 54.76579816155496],
              [-101.96240255681994, 55.06349392592592],
              [-101.64676109465397, 55.344288382771616],
              [-101.27974462125117, 55.60509523908456],
              [-100.86446233900305, 55.842983921788495],
              [-100.40479951548126, 56.0552254559182],
              [-99.9054001500129, 56.23933836340823],
              [-99.37162531309457, 56.393133163442606],
              [-98.80948587034128, 56.514753897581066],
              [-98.22554987089305, 56.60271503740913],
              [-97.62682665181842, 56.655932181702994],
              [-97.02063150467652, 56.67374512549909],
              [-96.4144363575346, 56.655932181702994],
            ],
          ],
        },
        properties: {},
      },
    ],
  });
});
Deno.test("should remove the small circle from the big circle, put the result in a new column and add a projection", async () => {
  const smallCircle = sdb.newTable();
  await smallCircle.loadGeoData("test/geodata/files/smallCircle.json");
  await smallCircle.renameColumns({ geom: "geomSmall" });

  const bigCircle = sdb.newTable();
  await bigCircle.loadGeoData("test/geodata/files/bigCircle.json");
  await bigCircle.renameColumns({ geom: "geomBig" });

  await smallCircle.crossJoin(bigCircle);

  await smallCircle.removeIntersection(
    "geomBig",
    "geomSmall",
    "bigCircleWithHole",
  );

  assertEquals(smallCircle.projections, {
    geomSmall: "+proj=latlong +datum=WGS84 +no_defs",
    geomBig: "+proj=latlong +datum=WGS84 +no_defs",
    bigCircleWithHole: "+proj=latlong +datum=WGS84 +no_defs",
  });
});

await sdb.done();
